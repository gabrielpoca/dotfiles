---
- hosts: local
  vars:
    home_dir: "{{ ansible_env.HOME }}"
    dotfiles_dir: "{{ home_dir }}/.dotfiles"
    homebrew_packages:
      - autoconf
      - automake
      - bash
      - bat
      - coreutils
      - diff-so-fancy
      - direnv
      - fzf
      - git
      - heroku/brew/heroku
      - hub
      - jq
      - libtool
      - libxslt
      - libyaml
      - mplayer
      - ncdu
      - neovim
      - openssl
      - postgresql
      - readline
      - reattach-to-user-namespace
      - tig
      - tldr
      - tmux
      - universal-ctags
      - unixodbc
      - wget
      - youtube-dl
      - zsh
      - zsh-completions

    homebrew_cask_packages:
      - brave-browser
      - caffeine
      - etcher
      - firefox
      - flux
      - font-fira-code
      - github-desktop
      - google-chrome
      - iterm2
      - licecap
      - playonmac
      - shiftit
      - slack
      - vagrant
      - virtualbox
      - vlc

  tasks:
  - name: link dotfiles
    file:
      src: "{{ dotfiles_dir}}/{{ item.src }}"
      dest: "{{ home_dir }}/{{ item.dest }}"
      state: link
    with_items:
      - { dest: ".default-gems", src: "default-gems" }
      - { dest: ".default-npm-packages", src: "default-npm-packages" }
      - { dest: ".gitattributes", src: "gitattributes" }
      - { dest: ".gitcommit", src: "gitcommit" }
      - { dest: ".gitconfig", src: "gitconfig" }
      - { dest: ".gitignore", src: "gitignore" }
      - { dest: ".rspec", src: "rspec" }
      - { dest: ".tmux.conf", src: "tmux.conf" }
      - { dest: ".tool-versions", src: "tool-versions" }
      - { dest: ".zshrc.local", src: "zshrc.local" }
      - { dest: ".config/nvim", src: "config/nvim" }

  - name: setup zsh
    include_tasks: "tasks/copy_file.yml"
    vars:
      src: "{{ dotfiles_dir }}/zshrc"
      dest: "{{ home_dir }}/.zshrc"

  - name: setup netrc
    include_tasks: "tasks/copy_file.yml"
    vars:
      src: "{{ dotfiles_dir }}/netrc"
      dest: "{{ home_dir }}/.netrc"

  - name: check if brew exists
    shell: command -v brew > /dev/null 2>&1
    register: brew_found
    ignore_errors: yes

  - name: install homebrew
    include_tasks: "tasks/brew.yml"
    when: brew_found == False

  - name: install homebrew cask packages
    homebrew_cask:
      name: "{{ homebrew_cask_packages }}"
      state: present

  - name: check if asdf exists
    stat:
      path: "{{ home_dir }}/.asdf"
    register: asdf_found

  - name: install asdf
    shell: |
      git clone https://github.com/asdf-vm/asdf.git ~/.asdf --branch v0.6.1
      echo -e '\n. $HOME/.asdf/asdf.sh' >> ~/.zshrc
      echo -e '\n. $HOME/.asdf/completions/asdf.bash' >> ~/.zshrc
    when: asdf_found.stat.exists == False

  - name: add asdf plugins
    shell: |
      asdf plugin-add nodejs
      asdf plugin-add ruby
      asdf plugin-add elixir
      asdf plugin-add python
      asdf plugin-add erlang
    ignore_errors: yes

  - name: check if terminfo exists
    stat:
      path: "{{ home_dir }}/.terminfo"
    register: terminfo_found

  - name: install terminfo
    shell: |
      system "tic -o {{ home_dir }}/.terminfo tmux.terminfo"
      system "tic -o {{ home_dir }}/.terminfo tmux-256color.terminfo"
      system "tic -o {{ home_dir }}/.terminfo xterm-256color.terminfo"
    when: terminfo_found.stat.exists == False

  - debug: msg="All done! Don't forget to update .zshrc and .netrc"
