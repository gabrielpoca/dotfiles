---
- hosts: local
  vars:
    home_dir: "{{ ansible_env.HOME }}"
    dotfiles_dir: "{{ home_dir }}/Developer/dotfiles"
    homebrew_packages:
      - autoconf
      - automake
      - bash
      - bat
      - coreutils
      - diff-so-fancy
      - direnv
      - exa
      - fzf
      - git
      - gpg
      - heroku/brew/heroku
      - hub
      - jq
      - libtool
      - libxslt
      - libyaml
      - mplayer
      - ncdu
      - neovim
      - openssl
      - postgresql
      - readline
      - reattach-to-user-namespace
      - ripgrep
      - the_silver_searcher
      - tig
      - tldr
      - tmux
      - unixodbc
      - wget
      - youtube-dl
      - zlib
      - zsh
      - zsh-completions

    homebrew_cask_packages:
      - brave-browser
      - caffeine
      - etcher
      - firefox
      - flux
      - font-fira-code
      - github-desktop
      - google-chrome
      - homebrew/cask-fonts/font-fira-code
      - iterm2
      - licecap
      - lulu
      - playonmac
      - quicklook-json
      - shiftit
      - slack
      - spectacle
      - vagrant
      - virtualbox
      - vlc

  tasks:
  - name: create .config directory
    file: path="{{ home_dir}}/.config" state=directory

  - name: link dotfiles
    file:
      src: "{{ dotfiles_dir}}/{{ item.src }}"
      dest: "{{ home_dir }}/{{ item.dest }}"
      state: link
    with_items:
      - { dest: ".default-gems", src: "default-gems" }
      - { dest: ".default-npm-packages", src: "default-npm-packages" }
      - { dest: ".gitattributes", src: "gitattributes" }
      - { dest: ".gitcommit", src: "gitcommit" }
      - { dest: ".gitconfig", src: "gitconfig" }
      - { dest: ".gitignore", src: "gitignore" }
      - { dest: ".rspec", src: "rspec" }
      - { dest: ".tmux.conf", src: "tmux.conf" }
      - { dest: ".tool-versions", src: "tool-versions" }
      - { dest: ".zshrc.local", src: "zshrc.local" }
      - { dest: ".config/nvim", src: "config/nvim" }

  - name: setup zsh if file doesn't exist
    include_tasks: "tasks/copy_file.yml"
    vars:
      src: "{{ dotfiles_dir }}/zshrc"
      dest: "{{ home_dir }}/.zshrc"

  - name: make zsh the default shell
    shell: chsh -s /bin/zsh

  - name: setup netrc if file doesn't exist
    include_tasks: "tasks/copy_file.yml"
    vars:
      src: "{{ dotfiles_dir }}/netrc"
      dest: "{{ home_dir }}/.netrc"

  - name: install homebrew
    include_tasks: "tasks/brew.yml"

  - name: check if asdf exists
    stat:
      path: "{{ home_dir }}/.asdf"
    register: asdf_found

  - name: install asdf
    shell: |
      git clone https://github.com/asdf-vm/asdf.git ~/.asdf --branch v0.6.1
      echo -e '\n. $HOME/.asdf/asdf.sh' >> ~/.zshrc
      echo -e '\n. $HOME/.asdf/completions/asdf.bash' >> ~/.zshrc
    when: asdf_found.stat.exists == False

  - name: add asdf plugins
    shell: |
      asdf plugin-add nodejs || true
      asdf plugin-add ruby || true
      asdf plugin-add elixir || true
      asdf plugin-add python || true
      asdf plugin-add erlang || true
    ignore_errors: yes

  - name: install terminfo
    shell: |
      tic -x {{ dotfiles_dir }}/tmux.terminfo
      tic -x {{ dotfiles_dir }}/tmux-256color.terminfo
      tic -x {{ dotfiles_dir }}/xterm-256color.terminfo

  - name: update vim-plug every monday
    cron:
      name: "update vim-plug"
      minute: "*/2"
      hour: "7,8,9,10,11,12"
      weekday: 1
      job: /bin/zsh -c "source ~/.zshrc && cron_update_vim_plug"

  - name: change color to light on saturdays
    cron:
      name: "color light"
      minute: "*/2"
      hour: "7,8,9,10,11,12,13,14,15"
      weekday: 6
      job: /bin/zsh -c "source ~/.zshrc && cron_color_light"

  - name: change color to dark every other day
    cron:
      name: "color dark"
      minute: "*/2"
      hour: "7,8,9,10,11,12,13"
      weekday: 0,1,2,3,4,5
      job: /bin/zsh -c "source ~/.zshrc && cron_color_dark"

  - name: check if TPM exists
    stat:
      path: "{{ home_dir }}/.tmux/plugins/tpm"
    register: tpm_found

  - name: install TPM
    shell: |
      mkdir -p ~/.tmux/plugins
      git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
    when: tpm_found.stat.exists == False

  - debug: msg="All done! Don't forget to update .zshrc and .netrc"
