#!/bin/bash -e

use_bee=false

while [[ $# -gt 0 ]]; do
    case "$1" in
        --bee)
            use_bee=true
            shift
            ;;
        *)
            echo "Unknown option: $1" >&2
            exit 1
            ;;
    esac
done

if [[ "$use_bee" == true ]]; then
    SECRETS_FILE="modules/priv/secrets/server.yaml"
else
    SECRETS_FILE="modules/priv/secrets/mac.yaml"
fi

if [[ ! -f "$SECRETS_FILE" ]]; then
    echo "Error: Secrets file not found at $SECRETS_FILE" >&2
    exit 1
fi

nix-shell -p sops --run "bash -c 'sops \"$SECRETS_FILE\" && sops updatekeys \"$SECRETS_FILE\"'"

echo "Successfully updated secrets at $SECRETS_FILE"
